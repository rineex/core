name: CI & Release

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']
  workflow_dispatch: # for manual stable release

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1️⃣ Quality Gates
  check:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [24]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm turbo run lint test build
      - uses: actions/cache@v3
        with:
          path: |
            .turbo
            node_modules/.cache/turbo
          key: turbo-${{ github.sha }}
          restore-keys: turbo-

  # 2️⃣ Canary Publish
  canary:
    runs-on: ubuntu-latest
    needs: check
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
      - run: pnpm install --frozen-lockfile
      - run: pnpm ci:canary

  # 3️⃣ Next / Pre-release
  next:
    runs-on: ubuntu-latest
    needs: check
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm bump:next
      - run: pnpm release:next
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore(release): next pre-release [skip ci]" || echo "No changes"
          VERSION=$(jq -r '.packages["@rineex/ddd"].version' .changeset/.tmp/changes.json || echo "next")
          git tag v$VERSION
          git push origin main --tags

  # 4️⃣ Stable Release
  stable:
    runs-on: ubuntu-latest
    needs: check
    if: github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm bump:stable
      - run: pnpm release:stable:ci
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore(release): stable release [skip ci]" || echo "No changes"
          VERSION=$(jq -r '.packages["@rineex/ddd"].version' .changeset/.tmp/changes.json || echo "stable")
          git tag v$VERSION
          git push origin main --tags
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Stable Release
          draft: false
          prerelease: false
